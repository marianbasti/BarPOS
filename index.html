<!DOCTYPE html>
<html lang="es" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>BarPOS</title>
    <style>
      body {font-family:calibri;background-color: #000000;box-sizing: border-box;-moz-box-sizing: border-box;-webkit-box-sizing: border-box;}
      h1 {width:100%;color:white}
      p {text-align: center; color: white}
      select {background-color: black; color: white; height:100%}
      select option:nth-child(odd) {background-color: #030303;}
      select optgroup {background-color: #222222; font-size: 3vh}
      table, td, th, tr{color: white;border: 1px solid black; border-collapse: collapse}
      .addcontrols {position: absolute; bottom: 0px; width:100%; height:6%; display: flex; align-items: center; flex-direction: row;}
      .totaltable {}
      .cantitem {text-align: right}
      .controls {position:absolute; top:10%; width:100%; height:90%}
      .controlscontainer {position:absolute;right:0px; top:0px; left:70%; height:90%; width:30%; border-radius: 2%;background-color: #222233;border:1px solid black; z-index:1;overflow-y: auto}
      .modalReservationTime {position: absolute; top:0;left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); z-index:201;display: flex; align-items: center; justify-content: center; flex-direction: column;}
      #modalCalendar {position: absolute; top:0;left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); z-index:201;display: flex; align-items: center; justify-content: center; flex-direction: column;}
      .monto {text-align: right;}
      .orderscontainer {margin: 0px;height: 90%; overflow-y: auto}
      .products {width:80% }
      .addsame {position: relative; margin-left: 5px; padding: 0px; text-align:center; top:50%; width:20px; height: 20px; color: white; border: 0px; background-color: #00cc00}
      .removesame {position: relative; margin-left: 5px; padding: 0px; text-align:center; top:50%; width:20px; height: 20px; background-color: #901010; color: white; border: 0px}
      .reservationControls {right:0px;font-size: 3vh !important; line-height:2.5vh; width:10vh; height:10%; position: absolute;background-color:rgba(0,0,0,0);color:white;font-size:5vh;}
      .reserved {position:absolute; width:20px; height:20px; top:-16%; left:-16%; border-radius: 50%; background-color: #ffa200; z-index:200}
      .table {border:0.5vh solid white;border-radius: 7%; position:absolute;width:10vh;height:10vh;background-color: #000000;text-align: center;vertical-align:center;line-height:5vh}
      .reservationParameters {width: 100%;height;30%;margin:2%}
      .reservationTimecontainer { padding: 5px;overflow: hidden;border: 2px solid white; border-radius: 10%; position: absolute; width:20%; height: 30%}
      .table:hover {cursor: pointer}
      .tablecontainer {position:fixed;top:0px;left:0px;width:100%; height:100%; z-index: 2; background-color: black}
      .tableheader {position:absolute;top:0px;height:10%;width:100%;text-align:center}
      .totaltable{ width:100%}
      #addproduct {height: :100%; background-color: #ffeb38}
      #closetable {position:fixed;padding: 0px; margin:0px;width:30%;height:10%;bottom:0px;background-color:#cc2222;color:white;font-size:5vh;border-radius: 5%}
      #confirmReservation { position: absolute;left:-2px;bottom: 0; width:101%; height:20%}
      #listReservations {position:absolute; height: 2.5vh;bottom:5px}
      #opentable {width:30%; height:100%; position: fixed; top:15%;z-index:99;background-color:#22cc22;color:white;font-size:5vh}
      #orderTable {width:100%}
      #reservetable {margin: 5px; font-size: 3vh !important; line-height:2.5vh; width:5vh; height:5vh; position: absolute;right: 0;z-index:99;background-color:#ffa200;color:white;font-size:5vh; border-radius: 30%}
      #reservationParameters {height:75%; width:96%;display: flex; align-items: center; justify-content: center; flex-direction: column}
    </style>
  </head>
  <body>
    <div class="tablecontainer" id='tablecontainer'>
      <div class="leftPanel" id='leftPanel'>
        <input type="button" id="resetTablesOrders" value="Limpiar TODAS las mesas">
        <input type="button" id="resetTablesReservations" value="Limpiar TODAS las reservas">
      </div>
      <div style='top:5%;right:5%' class="table" id='table1'>
        <div class='reserved' id='reserved1'></div>
        <p style='margin:0px' id='nombremesa1'>MESA 1</p>
        <p style='margin:0px' id='clock1' class='timer'></p>
      </div>
      <div style='top:5%;right:50%' class="table" id='table2'>
        <div class='reserved' id='reserved2'></div>
        <p style='margin:0px' id='nombremesa2'>MESA 2</p>
        <p style='margin:0px' id='clock2' class='timer'></p>
      </div>
      <div style='top:50%;right:5%' class="table" id='table3'>
        <div class='reserved' id='reserved3'></div>
        <p style='margin:0px' id='nombremesa3'>MESA 3</p>
        <p style='margin:0px' id='clock3' class='timer'></p>
      </div>
      <div style='top:50%;right:50%' class="table" id='table4'>
        <div class='reserved' id='reserved4'></div>
        <p style='margin:0px' id='nombremesa4'>MESA 4</p>
        <p style='margin:0px' id='clock4' class='timer'></p>
      </div>
      <div style='top:80%;right:80%' class="table" id='table5'>
        <div class='reserved' id='reserved5'></div>
        <p style='margin:0px' id='nombremesa5'>MESA 5</p>
        <p style='margin:0px' id='clock5' class='timer'></p>
      </div>
    </div>
    <div class="controlscontainer" id='controlscontainer'>
      <div class="tableheader">
        <h1 id='tablename'></h1>
      </div>
      <input type="button" id='opentable' value="Abrir mesa">
      <div class="reservationControls">
        <input type="button" id='reservetable' value="R">
        <input type="button" id='listReservations' value="Ver reservas">
      </div>
      <div class="controls" id='controls'>
        <div class="orderscontainer" id="orderscontainer">
          <div class="addcontrols">
            <select class="products" id="products">
            </select>
            <input type="button" id="addproduct" value="AÃ±adir">
          </div>
          <table id='orderTable'>
            <tr>
              <th>Item</th>
              <th>Cantidad</th>
              <th>Precio</th>
              <th></th>
            </tr>
          </table>
          <table class='totaltable' id='totaltable'>
            <tr>
              <th id=>Total</th>
              <th></th>
              <th id='total'> </th>
              <th></th>
            </tr>
          </table>
        </div>
        <input type="button" id="closetable" value="Cerrar mesa">
      </div>
    </div>
    <div class='modalReservationTime' id='modalReservationTime'>
      <div class='reservationTimecontainer'>
        <div id='reservationParameters' style='top:50%'>
          <input class='reservationParameters' type="text" id='reservationclient' placeholder="Nombre del cliente">
          <input class='reservationParameters' type="datetime-local" id='reservationdateInput'>
          <input class='reservationParameters' type="number" id="partyOfReservation" placeholder="Cantidad de comensales">
        </div>
        <input type="button" id="confirmReservation" value="Aceptar">
      </div>
    </div>
    <div id="modalCalendar">

    </div>
  </body>
</html>

<script src="/jquery-3.4.1.min.js"></script>
<script src="/socket.io/socket.io.js"></script>


<script type="text/javascript">


  class Reservation {
    constructor() {
      this.date = new Date();
      this.client = "";
      this.partyOf = 0;
    }
  }
  class TABLE {
    constructor() {
      this.isOpen = false;
      this.timer = new Date();
      this.isReserved = false;
      this.reservations = [];
      this.orders = new Array();
      this.total = 0
    }
  }

  var socket = io();
  var intervals = new Array(5);
  var orderNotification = new Audio('/order.mp3');
  //Notification sounds downloaded from https://notificationsounds.com
  //Provided under a Creative Commons Attribution license https://creativecommons.org/licenses/by/4.0/legalcode
  var openNotification = new Audio('/open.mp3');
  var closedNotification = new Audio('/closed.mp3');
  var resetNotification =new Audio('/reset.mp3');
  Number.prototype.toFixedDown = function(digits) {
    var n = this - Math.pow(10, -digits)/2;
    n += n / Math.pow(2, 53); // added 1360765523: 17.56.toFixedDown(2) === "17.56"
    return n.toFixed(digits);
  }

  var tables = [new TABLE(),new TABLE(),new TABLE(),new TABLE(),new TABLE()];
  var currentTime = new Date();
  var products;
  function checkTime(i) {
    if (i < 10) {i = "0" + i};  // add zero in front of numbers < 10
    return i;
  }

  //socket.emit('alteredorders',[tables,1]);
  $('#resetTablesOrders').on('click', function(){
    for (var i = 0; i<tables.length; i++){
      tables[i].orders = [];
    }
    console.log('Borrando todas las ordenes...');
    socket.emit('resetTablesOrders', [tables,1]);
  })

  $('#resetTablesReservations').on('click', function(){
    for (var i = 0; i<tables.length; i++){
      tables[i].reservations = [];
      tables[i].isReserved = false;
    }
    console.log('Borrando todas las reservas...');
    socket.emit('resetTablesReservations', [tables,1]);
  })

  function setClock(i) {
    intervals[i] = setInterval(function() {
      var time = new Date(currentTime - tables[i].timer);
      var h = checkTime(time.getHours());
      var m = checkTime(time.getMinutes());
      var s = checkTime(time.getSeconds());
      $('#clock' + Number(i+1)).text(h+':'+m+':'+s);
    },1000)
  }

  function populateOrderTable(table) {
    $('#orderTable').empty();
    $('#orderTable').append("<tr><th>Item</th><th>Cantidad</th><th>Precio</th><th></th></tr>");
    for (var i = 0; i<tables[table].orders.length; i++) {
      order = tables[table].orders[i];
      var markup = "<tr id='o" + i + "' class='" + order[1] + "'><td>" + order[2] + "</td><td class='cantitem'>" + order[3] + "<input class='addsame' type='button' value='+'><input class='removesame' type='button' value='-'></td><td class='monto'>" + order[0] + "</td><td> <input class='removeFromList' type='button' value='Quitar'></td></tr>";
      $("#orderTable tr:last").after(markup);
    }
  }

  function computeTotal() {
    console.log('comp');
    var total = 0;
    $('tr').each(function() {
      total = total + (Number($(this).find('.monto').text()) * Number($(this).find('.cantitem').text()));
    })
    return(total);
  }

  $('#clock1').hide();
  $('#clock2').hide();
  $('#clock3').hide();
  $('#clock4').hide();
  $('#clock5').hide();
  $('#reserved1').hide();
  $('#reserved2').hide();
  $('#reserved3').hide();
  $('#reserved4').hide();
  $('#reserved5').hide();
  $('#modalReservationTime').hide();
  $('#modalCalendar').hide();
  $('#modalCalendar').load('/calendar.html', function() {
    $('.wrapper').on('click', function () {
        $('#modalCalendar').fadeOut();
    })
  })

  $.getJSON("/productos.json", function(response) {
    var sel = $('#products');
    products = response;
   $.each(response, function(categoria){
     sel.append($("<optgroup>").attr('label',categoria));
     for (var i = 0; i<response[categoria].length; i++) {
       sel.append($("<option>").attr('value', [response[categoria][i].valor,response[categoria][i].dbid]).text(response[categoria][i].nombre));
     }
   })
  });
  $.getJSON("/tables.json", function(response) {
    for (var i = 0; i<tables.length; i++) {
      tables[i].isOpen = response[i].isOpen;
      tables[i].timer = new Date(response[i].timer);
      tables[i].isReserved = response[i].isReserved;
      tables[i].reservations = response[i].reservations;
      tables[i].orders = response[i].orders;
      tables[i].total = response[i].total;
      if (tables[i].isOpen == true) {
        $('#table' + Number(i+1)).css('background-color', '#22cc22');
        $('#clock' + Number(i+1)).show();
        setClock(i);
        console.log("Mesa " + Number(i+1) + ' estÃ¡ abierta');
      }
      if (tables[i].isReserved == true) {
        $('#reserved' + Number(i+1)).show();
      }
    }
  });
  $('#addproduct').on('click', function() {
    var tablealtered = $('#tablename').text()[5];
    itemval = $('#products option:selected').val().split(',');
    itemval.push($('#products option:selected').text());
    itemval.push(1);
    //alterar mesa
    tables[tablealtered-1].orders.push(itemval);
    console.log('Agregado item "' + itemval + '" a la mesa ' + Number(tablealtered));
    //AÃADIR ITEM CON SU NOMBRE, COSTO Y BOTON DE QUITAR
    var markup = "<tr id='o" + tables[tablealtered-1].orders.length + "' class='" + itemval[1] + "'><td>" + $('#products option:selected').text() + "</td><td class='cantitem'>1<input class='addsame' type='button' value='+'><input class='removesame' type='button' value='-'></td><td class='monto'>" + itemval[0] + "</td><td> <input class='removeFromList' type='button' value='Quitar'></td></tr>";
    $("#orderTable tr:last").after(markup);
    $('#total').text(computeTotal());
    tables[tablealtered-1].total = computeTotal();
    socket.emit('alteredorders', [tables, tablealtered]);

  })

  $("#orderTable").on('click', '.removeFromList', function() {
    var item = $(this).parent().parent().find('td:first').text();
    var tablealtered = $('#tablename').text()[5];
    for(var i = 0; i<tables[tablealtered-1].orders.length; i++) {
      if(tables[tablealtered-1].orders[i].includes(item)) {
        console.log('contiene ' + item + ' en posicion ' + i);
        tables[tablealtered-1].orders.splice(i,1)
      };
    }
    $(this).closest('tr').remove();
    $('#total').text(computeTotal());
    tables[$('#tablename').text()[5]-1].total = computeTotal();
    socket.emit('alteredorders', [tables, tablealtered]);
  })
  $("#orderTable").on('click', '.addsame', function(e) {
    e.stopPropagation();
    tables[$('#tablename').text()[5]-1].orders[$(this).closest('tr').attr('id')[1]][3]++;
    var markup = "<input class='addsame' type='button' value='+'><input class='removesame' type='button' value='-'>";
    $(this).closest('.cantitem').html(Number($(this).closest('.cantitem').text())+1 + markup);
    $('#total').text(computeTotal());
    tables[$('#tablename').text()[5]-1].total = computeTotal();
    socket.emit('alteredorders', [tables, $('#tablename').text()[5]]);
  })
  $("#orderTable").on('click', '.removesame', function(e) {
    e.stopPropagation();
    var markup = "<input class='addsame' type='button' value='+'><input class='removesame' type='button' value='-'>";
    if (Number($(this).closest('.cantitem').text()) > 1 ) {
      tables[$('#tablename').text()[5]-1].orders[$(this).closest('tr').attr('id')[1]][3]--;
      $(this).closest('.cantitem').html(Number($(this).closest('.cantitem').text())-1 + markup);
      $('#total').text(computeTotal());
      tables[$('#tablename').text()[5]-1].total = computeTotal();
      socket.emit('alteredorders', [tables, $('#tablename').text()[5]]);
    }
  })


  $('#opentable').on('click', function() {
    var tableopened = $('#tablename').text();
    $('#table' + tableopened[5]).css('background-color', '#22cc22');
    tables[tableopened[5]-1].isOpen = true;
    $('#closetable').show();
    $('#opentable').fadeOut('fast');
    tables[tableopened[5]-1].timer.setTime(currentTime);
    setClock(tableopened[5]-1);
    $('#clock' + tableopened[5]).fadeIn();
    console.log('Abriendo mesa '+ tableopened[5]);
    socket.emit('tableopened', [tables, tableopened[5]]);
  });

  $('#closetable').on('click', function() {
    if (confirm('Cerrar mesa?')) {
      var tableclosed = $('#tablename').text()[5];
      $('#table' + tableclosed).css('background-color', '#000000');
      tables[tableclosed-1].isOpen = false;
      tables[tableclosed-1].orders = [];
      populateOrderTable(tableclosed-1)
      $('#closetable').fadeOut('fast');
      $('#opentable').fadeIn('fast');
      $('#clock' + tableclosed).fadeOut();
      clearInterval(intervals[tableclosed-1]);
      console.log('Cerrando mesa '+ tableclosed);
      socket.emit('tableclosed', [tables, tableclosed]);
    }
  });

  $('#tablecontainer').on('click', function() {
    $('#tablecontainer').animate({width: '100%'});
  })

  $('.table').on('click', function(e) {
    e.stopPropagation();
    var tableclicked = $(this).attr('id')[5];
    console.log(tables[tableclicked-1].orders);
      populateOrderTable(tableclicked-1);
    if (tables[tableclicked-1].isOpen == true) {
      $('#opentable').hide();
      $('#closetable').show();
      $('#total').text(computeTotal());
    } else {
      $('#opentable').show();
      $('#closetable').hide();
    }
    $('#tablename').text("Mesa " + tableclicked);
    $('#tablecontainer').animate({width: '70%'});
  });


  $('#reservetable').on('click', function() {
    var mesa = $('#tablename').text()[5];
    $('#modalReservationTime').fadeIn();

  })
  $('#modalReservationTime').on('click', function() {
    $('#modalReservationTime').fadeOut()
    $('#reservationclient').val('');
    $('#reservationdateInput').val('');
    $('#partyOfReservation').val('');
  })
  $('#reservationParameters').on('click', function(e) {
    e.stopPropagation();
  })
  $('#confirmReservation').on('click', function(e) {
    e.stopPropagation();
    var mesa = $('#tablename').text()[5];
    var client = $('#reservationclient').val();
    var unfDate = $('#reservationdateInput').val();
    var party = $('#partyOfReservation').val();
    var newReservation = new Reservation();
    var forDate = new Date();
    tables[mesa-1].isReserved= true;
    forDate.setMinutes(unfDate.split(':')[1]);
    forDate.setHours(unfDate.split('T')[1].split(':')[0]);
    forDate.setDate(unfDate.split('-')[1]);
    forDate.setMonth(unfDate.split('-')[2].split('T')[0]);
    forDate.setYear(unfDate.split('-')[0]);
    //newReservation.date.setDate(unfDate);
    newReservation.date= forDate;
    newReservation.client = client;
    newReservation.partyOf = party;
    tables[mesa-1].reservations.push(newReservation);
    socket.emit('alteredreserv', [tables, mesa]);
    $('#modalReservationTime').fadeOut();
  })
  $('#listReservations').on('click', function() {
      $('#modalCalendar').fadeIn();
      $('.calendar').on('click', function(e) {
        e.stopPropagation();
      });
  })

  setInterval(function () {
    currentTime = new Date();
  }, 1000)

  $(function() {
    socket.on('pong', function() {
      console.log('Pong');
    })
    socket.on('tableopenedres', function(num){
      console.log('Mesa '+ num + ' abierta');
      tables[num-1].isOpen = true;
      $('#table' + num).css('background-color', '#22cc22');
      $('#clock' + num).fadeIn();
      if ($('#tablename').text()[5] == num) {
        $('#opentable').fadeOut('fast');
        $('#closetable').fadeIn('fast');
      }
      openNotification.play();
    });
    socket.on('tableclosedres', function(num){
      console.log('Mesa ' + num + ' cerrada');
      tables[num-1].isOpen = false;
      tables[num-1].orders = [];
      $('#table' + num).css('background-color', '#000000');
      $('#clock' + num).fadeOut();
      if ($('#tablename').text()[5] == num) {
        $('#opentable').fadeIn('fast');
        $('#closetable').fadeOut('fast');
      }
      closedNotification.play();
    });
    socket.on('alteredordersres', function(newData) {
      console.log('Ordenes alteradas de mesa ' + newData[0]);
      console.log('Orden ' + newData[1]);
      tables[newData[0]-1].orders = newData[1];
      if ($('#tablename').text()[5] == newData[0]) {
        populateOrderTable(newData[0]-1);
        $('#total').text(computeTotal());
      }
      tables[newData[0]-1].total = computeTotal();
      orderNotification.play();
    })
    socket.on('alteredreservres', function(newData) {
      console.log('Se reservo la mesa ' + newData[0]);
      console.log(newData[1].reservations);
      tables[newData[0]-1].reservations = newData[1];
      if(newData[1].isReserved == true) {
        tables[newData[0]-1].isReserved = true;
        $('#reserved' + newData[0]).fadeIn('fast');
      } else {
        $('#reserved' + newData[0]).fadeOut('fast');
      }
      orderNotification.play();
    })
    socket.on('resetTablesOrdersRes', function(newData) {
      console.log('Se borraron todos los pedidos de las mesas');
      resetNotification.play();
    })
    socket.on('resetTablesReservationsRes', function(newData) {
      console.log('Se borraron todos las reservas de las mesas');
      for (var i = 0; i<tables.length; i++){
        $('#reserved' + Number(i+1)).fadeOut();
      }
      resetNotification.play();
    })
  })
</script>
